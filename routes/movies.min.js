var express=require("express"),router=express.Router(),Movie=require("../models/movie"),middleware=require("../middleware"),request=require("request"),multer=require("multer"),storage=multer.diskStorage({filename:function(e,i,r){r(null,Date.now()+i.originalname)}}),imageFilter=function(e,i,r){if(!i.originalname.match(/\.(jpg|jpeg|png|gif)$/i))return r(new Error("Only image files are allowed."),!1);r(null,!0)},upload=multer({storage:storage,fileFilter:imageFilter}),cloudinary=require("cloudinary");function escapeRegex(e){return e.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")}cloudinary.config({cloud_name:"justinupload",api_key:"946456241342922",api_secret:process.env.CLOUDINARY_API_SECRET}),router.get("/",function(e,i){if(e.query.search){var r=new RegExp(escapeRegex(e.query.search),"gi");Movie.find({name:r},function(r,o){if(r)e.flash("error",r);else{if(o.length<1)return e.flash("warning","Found no Movies. Please search again."),i.redirect("movies/index");i.render("movies/index",{movies:o,page:"movies"})}})}else Movie.find({},function(r,o){r?e.flash("error",r):i.render("movies/index",{movies:o,page:"movies"})})}),router.post("/",middleware.isLoggedIn,upload.single("image"),function(e,i){cloudinary.v2.uploader.upload(e.file.path,function(r,o){if(r)return e.flash("error",r.message),i.redirect("back");e.body.movie.image=o.secure_url,e.body.movie.image_id=o.public_id,e.body.movie.author={id:e.user._id,username:e.user.username},newMovie={name:e.body.movie.name,image:e.body.movie.image,description:e.body.movie.description,author:e.body.movie.author,rating:e.body.movie.rating},Movie.create(newMovie,function(r,o){r?e.flash("error",r):i.redirect("/movies")})})}),router.get("/new",middleware.isLoggedIn,function(e,i){i.render("movies/new")}),router.get("/:id",function(e,i){Movie.findById(e.params.id).populate("comments").exec(function(r,o){r||!o?(e.flash("error","Movie not found."),i.redirect("back")):i.render("movies/show",{movie:o})})}),router.get("/:id/edit",middleware.movieOwnership,function(e,i){Movie.findById(e.params.id,function(e,r){i.render("movies/edit",{movie:r})})}),router.put("/:id",middleware.movieOwnership,function(e,i){newData={name:e.body.movie.name,image:e.body.movie.image,description:e.body.movie.description,rating:e.body.movie.rating},Movie.findByIdAndUpdate(e.params.id,{$set:newData},function(r,o){r?(e.flash("error","Something went wrong."),i.redirect("back")):(e.flash("success","Successfully Updated!"),i.redirect("/movies/"+e.params.id))})}),router.delete("/:id",middleware.movieOwnership,function(e,i){Movie.findByIdAndRemove(e.params.id,function(r,o){r?(e.flash("error","Something went wrong"),i.redirect("/movies")):i.redirect("/movies")})}),module.exports=router;