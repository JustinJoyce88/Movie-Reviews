var express=require("express"),router=express.Router({mergeParams:!0}),Movie=require("../models/movie"),Comment=require("../models/comment"),middleware=require("../middleware");router.get("/new",middleware.isLoggedIn,function(e,r){Movie.findById(e.params.id,function(e,o){e?console.log(e):r.render("comments/new",{movie:o})})}),router.post("/",middleware.isLoggedIn,function(e,r){Movie.findById(e.params.id,function(o,n){o?(e.flash("error","Something went wrong."),r.redirect("/movies")):Comment.create(e.body.comment,function(o,m){o?console.log(o):(m.author.id=e.user._id,m.author.username=e.user.username,m.save(),n.comments.push(m),n.save(),r.redirect("/movies/"+n._id))})})}),router.get("/:comment_id/edit",middleware.commentOwnership,function(e,r){Movie.findById(e.params.id,function(o,n){if(o||!n)return e.flash("error","Something went wrong."),r.redirect("back");Comment.findById(e.params.comment_id,function(o,n){o?(e.flash("error","Something went wrong."),r.redirect("back")):r.render("comments/edit",{movie_id:e.params.id,comment:n})})})}),router.put("/:comment_id/",middleware.commentOwnership,function(e,r){Comment.findByIdAndUpdate(e.params.comment_id,e.body.comment,function(o,n){o?(e.flash("error","Something went wrong."),r.redirect("back")):r.redirect("/movies/"+e.params.id)})}),router.delete("/:comment_id",middleware.commentOwnership,function(e,r){Comment.findByIdAndRemove(e.params.comment_id,function(o){o?(e.flash("error","Something went wrong."),r.redirect("back")):(e.flash("success","Comment deleted."),r.redirect("/movies/"+e.params.id))})}),module.exports=router;